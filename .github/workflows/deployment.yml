name: Deployment prod nginx

on: [ push, pull_request ]

jobs:

  # Deploy frontend
  deploy-prod-nginx:

    if: github.ref == 'refs/heads/guilledev'

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Create env variables file
        run: |
          echo "PORT80=${{ secrets.ANGEMY_PROD_PORT80 }}" > .env
          echo "PORT443=${{ secrets.ANGEMY_PROD_PORT443 }}" >> .env
          echo 'DOMAINS="${{ secrets.ANGEMY_PROD_DOMAINS }}"' >> .env
          echo "DOMAIN=${{ secrets.ANGEMY_PROD_DOMAIN }}" >> .env
          echo "EMAIL=contact@guilledev.com" >> .env
          echo "ANGEMY_PROD_FRONTEND_PORT=${{ secrets.ANGEMY_PROD_FRONTEND_PORT }}" >> .env
          echo "CERTBOT_CERT_PATH=${{ secrets.ANGEMY_PROD_CERTBOT_CERT_PATH }}" >> .env

      - name: Generate nginx.config file
        run: ./generate_config.sh nginx.angemy.conf

      - name: Copy project to the hosting
        uses: easingthemes/ssh-deploy@v2.1.5
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SERVER_SSH_KEY }}
          ARGS: "-rltgoDzvO --delete"
          SOURCE: ""
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          TARGET: ${{ secrets.PROD_ANGEMY__REMOTE_TARGET }}

      - name: Deploy project with docker in hosting
        uses: garygrossgarten/github-action-ssh@release
        with:
          command: cd ${{ secrets.PROD_ANGEMY__REMOTE_TARGET }} && ./deploy.sh prod_angemy
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          privateKey: ${{ secrets.SERVER_SSH_KEY}}
